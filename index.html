import React, { useState, useEffect, useCallback } from 'react';
import { Crown, Shield, Sword, Gem, Coins, RotateCcw, Play, Trophy } from 'lucide-react';

// --- ì„¤ì • ë° ìƒìˆ˜ ---
const BOARD_SIZE = 8;
const TYPES = ['crown', 'shield', 'sword', 'gem', 'coin', 'potion'];
const TARGET_SCORE = 1500;
const MAX_MOVES = 20;

// ì•„ì´ì½˜ ë§¤í•‘
const Icons = {
  crown: { component: Crown, color: 'text-yellow-400', bg: 'bg-yellow-900/40' },
  shield: { component: Shield, color: 'text-slate-300', bg: 'bg-slate-700/40' },
  sword: { component: Sword, color: 'text-blue-400', bg: 'bg-blue-900/40' },
  gem: { component: Gem, color: 'text-pink-500', bg: 'bg-pink-900/40' },
  coin: { component: Coins, color: 'text-amber-500', bg: 'bg-amber-800/40' },
  potion: { component: Trophy, color: 'text-purple-400', bg: 'bg-purple-900/40' }, // Trophyë¥¼ í¬ì…˜/ëª©í‘œë¬¼ ëŒ€ìš©ìœ¼ë¡œ ì‚¬ìš©
};

export default function App() {
  const [board, setBoard] = useState([]);
  const [selected, setSelected] = useState(null);
  const [score, setScore] = useState(0);
  const [moves, setMoves] = useState(MAX_MOVES);
  const [gameState, setGameState] = useState('start'); // start, playing, won, lost
  const [isProcessing, setIsProcessing] = useState(false);
  const [animatingRows, setAnimatingRows] = useState([]);

  // --- ê²Œì„ ë¡œì§ ---

  // ë¬´ì‘ìœ„ ì•„ì´í…œ ìƒì„±
  const getRandomType = () => TYPES[Math.floor(Math.random() * TYPES.length)];

  // ì´ˆê¸° ë³´ë“œ ìƒì„± (ë§¤ì¹˜ê°€ ì—†ëŠ” ìƒíƒœë¡œ ì‹œì‘í•˜ë„ë¡ ê°„ë‹¨í•œ ê²€ì‚¬ í¬í•¨ ê°€ëŠ¥í•˜ë‚˜, ì—¬ê¸°ì„  ëœë¤ í›„ ìë™ í´ë¦¬ì–´ ë°©ì‹ ì‚¬ìš©)
  const initGame = useCallback(() => {
    const newBoard = [];
    for (let r = 0; r < BOARD_SIZE; r++) {
      const row = [];
      for (let c = 0; c < BOARD_SIZE; c++) {
        row.push({ type: getRandomType(), id: `r${r}-c${c}-${Date.now()}` });
      }
      newBoard.push(row);
    }
    setBoard(newBoard);
    setScore(0);
    setMoves(MAX_MOVES);
    setGameState('playing');
    setIsProcessing(false);
    setSelected(null);
  }, []);

  // ë§¤ì¹˜ í™•ì¸ í•¨ìˆ˜
  const checkMatches = (currentBoard) => {
    const matched = new Set();

    // ê°€ë¡œ ë§¤ì¹˜
    for (let r = 0; r < BOARD_SIZE; r++) {
      for (let c = 0; c < BOARD_SIZE - 2; c++) {
        const type = currentBoard[r][c]?.type;
        if (!type) continue;
        if (currentBoard[r][c + 1]?.type === type && currentBoard[r][c + 2]?.type === type) {
          matched.add(`${r},${c}`);
          matched.add(`${r},${c + 1}`);
          matched.add(`${r},${c + 2}`);
        }
      }
    }

    // ì„¸ë¡œ ë§¤ì¹˜
    for (let r = 0; r < BOARD_SIZE - 2; r++) {
      for (let c = 0; c < BOARD_SIZE; c++) {
        const type = currentBoard[r][c]?.type;
        if (!type) continue;
        if (currentBoard[r + 1][c]?.type === type && currentBoard[r + 2][c]?.type === type) {
          matched.add(`${r},${c}`);
          matched.add(`${r + 1},${c}`);
          matched.add(`${r + 2},${c}`);
        }
      }
    }

    return Array.from(matched).map(str => {
      const [r, c] = str.split(',').map(Number);
      return { r, c };
    });
  };

  // ë³´ë“œ ì—…ë°ì´íŠ¸ ë° ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
  useEffect(() => {
    if (gameState !== 'playing') return;

    const processBoard = async () => {
      // 1. ë§¤ì¹˜ í™•ì¸
      const matches = checkMatches(board);

      if (matches.length > 0) {
        setIsProcessing(true);
        
        // ì ìˆ˜ ì¶”ê°€ (ë§¤ì¹˜ëœ ê°œìˆ˜ * 10)
        setScore(prev => prev + matches.length * 10);

        // 2. ë§¤ì¹˜ëœ íƒ€ì¼ ì œê±° (ì ì‹œ ëŒ€ê¸° íš¨ê³¼)
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const newBoard = board.map(row => row.map(cell => ({ ...cell })));
        matches.forEach(({ r, c }) => {
          newBoard[r][c] = null; // ë¹ˆ ê³µê°„ìœ¼ë¡œ ë§Œë“¦
        });
        setBoard(newBoard);

        // 3. íƒ€ì¼ ë–¨ì–´íŠ¸ë¦¬ê¸° (Gravity)
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const gravityBoard = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));
        
        for (let c = 0; c < BOARD_SIZE; c++) {
          let writeRow = BOARD_SIZE - 1;
          // ì•„ë˜ì—ì„œ ìœ„ë¡œ ìŠ¤ìº”í•˜ì—¬ ìˆëŠ” íƒ€ì¼ë“¤ì„ ì•„ë˜ë¡œ ìŒ“ìŒ
          for (let r = BOARD_SIZE - 1; r >= 0; r--) {
            if (newBoard[r][c]) {
              gravityBoard[writeRow][c] = newBoard[r][c];
              writeRow--;
            }
          }
          // ë‚˜ë¨¸ì§€ëŠ” ìœ„ì—ì„œë¶€í„° ëœë¤ ì±„ìš°ê¸°
          for (let r = writeRow; r >= 0; r--) {
            gravityBoard[r][c] = { type: getRandomType(), id: `new-${Date.now()}-${r}-${c}` };
          }
        }
        setBoard(gravityBoard);

        // ì—°ì‡„ ì‘ìš©ì„ ìœ„í•´ ë‹¤ì‹œ ì²´í¬í•˜ë„ë¡ íŠ¸ë¦¬ê±° (useEffectê°€ board ë³€ê²½ìœ¼ë¡œ ë‹¤ì‹œ ì‹¤í–‰ë¨)
      } else {
        setIsProcessing(false);
        // ë§¤ì¹˜ê°€ ë” ì´ìƒ ì—†ê³ , movesê°€ 0ì´ë©´ ê²Œì„ ì˜¤ë²„ ì²´í¬
        if (moves <= 0 && score < TARGET_SCORE) {
          setGameState('lost');
        } else if (score >= TARGET_SCORE) {
          setGameState('won');
        } else if (moves <= 0) {
          // ì ìˆ˜ëŠ” ë„˜ì—ˆìœ¼ë‚˜ ì´ë™ íšŸìˆ˜ ëë‚¨ (ë³´í†µ ìŠ¹ë¦¬ ì²˜ë¦¬í•˜ê±°ë‚˜ ì¶”ê°€ ë³´ë„ˆìŠ¤)
          setGameState('won');
        }
      }
    };

    if (board.length > 0) {
        // ë”œë ˆì´ë¥¼ ì£¼ì–´ ë Œë”ë§ í›„ ë¡œì§ ì‹¤í–‰
        const timer = setTimeout(processBoard, 100);
        return () => clearTimeout(timer);
    }
  }, [board, gameState, moves]); // scoreëŠ” ì˜ì¡´ì„±ì—ì„œ ì œì™¸í•˜ì—¬ ë¬´í•œ ë£¨í”„ ë°©ì§€ (ì ìˆ˜ ì—…ë°ì´íŠ¸ëŠ” ë‚´ë¶€ì—ì„œ)

  // íƒ€ì¼ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleTileClick = (r, c) => {
    if (gameState !== 'playing' || isProcessing) return;

    if (!selected) {
      setSelected({ r, c });
    } else {
      // ê°™ì€ íƒ€ì¼ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
      if (selected.r === r && selected.c === c) {
        setSelected(null);
        return;
      }

      // ì¸ì ‘í•œ íƒ€ì¼ì¸ì§€ í™•ì¸ (ëŒ€ê°ì„  ì œì™¸)
      const isAdjacent = Math.abs(selected.r - r) + Math.abs(selected.c - c) === 1;

      if (isAdjacent) {
        // ìŠ¤ì™‘ ì‹œë„
        attemptSwap(selected, { r, c });
        setSelected(null);
      } else {
        // ë©€ë¦¬ ìˆëŠ” íƒ€ì¼ í´ë¦­ ì‹œ ì„ íƒ ë³€ê²½
        setSelected({ r, c });
      }
    }
  };

  const attemptSwap = async (pos1, pos2) => {
    setIsProcessing(true);

    // 1. ê°€ìƒ ìŠ¤ì™‘
    const tempBoard = board.map(row => row.map(cell => ({ ...cell })));
    const temp = tempBoard[pos1.r][pos1.c];
    tempBoard[pos1.r][pos1.c] = tempBoard[pos2.r][pos2.c];
    tempBoard[pos2.r][pos2.c] = temp;

    setBoard(tempBoard); // UI ì—…ë°ì´íŠ¸ (ìŠ¤ì™‘ ì• ë‹ˆë©”ì´ì…˜ ëŒ€ìš©)

    // 2. ìœ íš¨ì„± ê²€ì‚¬
    const matches = checkMatches(tempBoard);

    if (matches.length > 0) {
      // ìœ íš¨í•œ ì´ë™: ì´ë™ íšŸìˆ˜ ê°ì†Œí•˜ê³  ë£¨í”„ ì§„í–‰
      setMoves(prev => prev - 1);
      // useEffectê°€ matchesë¥¼ ê°ì§€í•˜ê³  ì²˜ë¦¬í•¨
    } else {
      // ë¬´íš¨í•œ ì´ë™: ë˜ëŒë¦¬ê¸°
      await new Promise(resolve => setTimeout(resolve, 300));
      setBoard(board); // ì›ë˜ëŒ€ë¡œ ë³µêµ¬
      setIsProcessing(false);
    }
  };

  // --- ë Œë”ë§ í—¬í¼ ---
  
  const getProgressWidth = () => Math.min(100, (score / TARGET_SCORE) * 100);

  return (
    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 font-sans text-slate-100 select-none overflow-hidden">
      
      {/* ë°°ê²½ ì¥ì‹ */}
      <div className="absolute inset-0 bg-gradient-to-br from-blue-900 via-slate-900 to-slate-950 -z-10" />
      <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-black/50 to-transparent -z-10" />

      {/* í—¤ë” ì˜ì—­: ì™•ê³¼ ëª©í‘œ */}
      <div className="w-full max-w-md flex flex-col gap-4 mb-4">
        
        {/* ìƒë‹¨ ë°” */}
        <div className="flex justify-between items-center px-2">
            <div className="bg-slate-800/80 rounded-xl px-4 py-2 border border-slate-600 flex flex-col items-center min-w-[80px]">
                <span className="text-xs text-slate-400 uppercase font-bold tracking-wider">Moves</span>
                <span className={`text-2xl font-black ${moves <= 5 ? 'text-red-500 animate-pulse' : 'text-white'}`}>{moves}</span>
            </div>
            
            <div className="flex-1 mx-4 flex flex-col justify-center">
                 <div className="flex justify-between text-xs mb-1 font-bold text-yellow-500">
                    <span>SCORE</span>
                    <span>{score} / {TARGET_SCORE}</span>
                 </div>
                 <div className="h-4 bg-slate-800 rounded-full overflow-hidden border border-slate-700 relative">
                    <div 
                        className="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 transition-all duration-500 ease-out"
                        style={{ width: `${getProgressWidth()}%` }}
                    />
                    {/* ê´‘íƒ íš¨ê³¼ */}
                    <div className="absolute top-0 left-0 w-full h-1/2 bg-white/20" />
                 </div>
            </div>

            <button 
                onClick={initGame}
                className="p-3 bg-blue-600 hover:bg-blue-500 rounded-xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all"
            >
                <RotateCcw size={20} className="text-white" />
            </button>
        </div>

        {/* ì™• ìºë¦­í„° (ê°„ë‹¨í•œ ë¹„ì£¼ì–¼) */}
        <div className="flex justify-center -mb-6 z-10 relative">
            <div className="w-20 h-20 bg-gradient-to-br from-red-500 to-red-700 rounded-full border-4 border-yellow-400 shadow-xl flex items-center justify-center">
                <Crown size={40} className="text-yellow-100 drop-shadow-md" />
            </div>
            {gameState === 'won' && (
                <div className="absolute -top-4 bg-yellow-400 text-yellow-900 font-bold px-3 py-1 rounded-full text-xs animate-bounce shadow-md">
                    Fantastic!
                </div>
            )}
        </div>
      </div>

      {/* ê²Œì„ ë³´ë“œ ì»¨í…Œì´ë„ˆ */}
      <div className="relative bg-[#2c3e50] p-3 rounded-2xl shadow-2xl border-4 border-[#34495e] w-full max-w-md aspect-square">
        {/* ë‚´ë¶€ ë³´ë“œ ë°°ê²½ (ê²©ì) */}
        <div 
            className="w-full h-full grid grid-cols-8 grid-rows-8 gap-1 bg-[#202c39] rounded-xl p-1 overflow-hidden relative"
        >
            {gameState === 'start' ? (
                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm rounded-xl">
                     <h1 className="text-4xl font-black text-yellow-400 mb-2 drop-shadow-lg" style={{ fontFamily: 'serif' }}>ROYAL GAME</h1>
                     <p className="text-slate-300 mb-6">Match 3 items to save the King!</p>
                     <button 
                        onClick={initGame}
                        className="flex items-center gap-2 px-8 py-4 bg-green-500 hover:bg-green-400 text-white font-bold rounded-full shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all text-xl"
                    >
                        <Play fill="currentColor" /> PLAY
                    </button>
                </div>
            ) : null}

            {/* ê·¸ë¦¬ë“œ ë Œë”ë§ */}
            {board.map((row, r) => (
                row.map((cell, c) => {
                    if (!cell) return <div key={`empty-${r}-${c}`} className="rounded-lg bg-slate-800/30" />;
                    
                    const IconData = Icons[cell.type];
                    const IconComponent = IconData.component;
                    const isSelected = selected?.r === r && selected?.c === c;
                    
                    return (
                        <div
                            key={cell.id}
                            onClick={() => handleTileClick(r, c)}
                            className={`
                                relative rounded-lg flex items-center justify-center cursor-pointer transition-all duration-200
                                ${IconData.bg}
                                ${isSelected ? 'ring-4 ring-white z-10 scale-110 brightness-125' : 'hover:brightness-110'}
                                ${gameState !== 'playing' ? 'opacity-50' : 'opacity-100'}
                            `}
                            style={{
                                boxShadow: isSelected ? '0 0 15px rgba(255,255,255,0.5)' : 'inset 0 -3px 0 rgba(0,0,0,0.2)'
                            }}
                        >
                            <IconComponent 
                                size={28} 
                                className={`${IconData.color} drop-shadow-md`} 
                                strokeWidth={2.5}
                            />
                            {/* ë°˜ì§ì„ íš¨ê³¼ */}
                            <div className="absolute top-1 right-1 w-1.5 h-1.5 bg-white/40 rounded-full" />
                        </div>
                    );
                })
            ))}
        </div>
        
        {/* ê²°ê³¼ ëª¨ë‹¬ */}
        {(gameState === 'won' || gameState === 'lost') && (
             <div className="absolute inset-0 z-30 flex flex-col items-center justify-center bg-black/80 backdrop-blur-md rounded-xl animate-in fade-in zoom-in duration-300">
                {gameState === 'won' ? (
                    <>
                        <Trophy size={64} className="text-yellow-400 mb-4 animate-bounce" />
                        <h2 className="text-4xl font-black text-white mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600">VICTORY!</h2>
                        <p className="text-slate-300 mb-6">Score: {score}</p>
                    </>
                ) : (
                    <>
                        <div className="text-6xl mb-4">ğŸ˜¢</div>
                        <h2 className="text-3xl font-black text-red-500 mb-2">OUT OF MOVES</h2>
                        <p className="text-slate-300 mb-6">Try again to save the King!</p>
                    </>
                )}
                <button 
                    onClick={initGame}
                    className="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-full shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all"
                >
                    PLAY AGAIN
                </button>
             </div>
        )}
      </div>

      {/* í•˜ë‹¨ ì„¤ëª… */}
      <div className="mt-6 text-slate-500 text-sm font-medium">
        Target: {TARGET_SCORE} points in {MAX_MOVES} moves
      </div>

      <style jsx global>{`
        @keyframes pop {
          0% { transform: scale(0.8); opacity: 0; }
          100% { transform: scale(1); opacity: 1; }
        }
      `}</style>
    </div>
  );
}



